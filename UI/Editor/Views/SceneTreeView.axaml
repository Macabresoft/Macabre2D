<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Macabresoft.Macabre2D.UI.Editor"
             xmlns:framework="clr-namespace:Macabresoft.Macabre2D.Framework;assembly=Macabre2D.Framework"
             xmlns:common="clr-namespace:Macabresoft.Macabre2D.UI.Common;assembly=Macabre2D.UI.Common"
             x:Class="Macabresoft.Macabre2D.UI.Editor.SceneTreeView">
    <UserControl.Resources>
        <common:ObjectToEnumerableConverter x:Key="ObjectToEnumerableConverter" />
    </UserControl.Resources>
    <Border DataContext="{Binding $parent[local:SceneTreeView].ViewModel}"
            Classes="Card"
            Margin="{DynamicResource StandardMarginLeftTopBottom}">
        <Design.DataContext>
            <local:SceneTreeViewModel />
        </Design.DataContext>
        <Grid RowDefinitions="Auto, *, 0">
            <StackPanel Grid.Row="0"
                        Orientation="Horizontal"
                        IsVisible="{Binding SceneService.IsEntityContext}">
                <Button Command="{Binding AddEntityCommand}"
                        Classes="Icon"
                        ToolTip.Tip="Add an entity as a child of the selected entity">
                    <Button.ContextMenu>
                        <ContextMenu Items="{Binding $parent[local:SceneTreeView].AddEntityMenuItems}">
                            <ContextMenu.Styles>
                                <Style Selector="MenuItem">
                                    <Setter Property="Command" Value="{Binding $parent[Button].Command}" />
                                </Style>
                            </ContextMenu.Styles>
                        </ContextMenu>
                    </Button.ContextMenu>

                    <common:Icon Content="{DynamicResource AddIcon}" />
                </Button>
                <Button Command="{Binding RemoveEntityCommand}"
                        CommandParameter="{Binding SceneService.ImpliedSelected}"
                        Classes="Icon"
                        ToolTip.Tip="Remove the selected entity and all of its children from the scene">
                    <common:Icon Content="{DynamicResource RemoveIcon}" />
                </Button>
            </StackPanel>

            <StackPanel Grid.Row="0"
                        Orientation="Horizontal"
                        IsVisible="{Binding !SceneService.IsEntityContext}">
                <Button Command="{Binding AddSystemCommand}"
                        Classes="Icon"
                        ToolTip.Tip="Add a system to the scene">
                    <Button.ContextMenu>
                        <ContextMenu Items="{Binding $parent[local:SceneTreeView].AddSystemMenuItems}">
                            <ContextMenu.Styles>
                                <Style Selector="MenuItem">
                                    <Setter Property="Command" Value="{Binding $parent[Button].Command}" />
                                </Style>
                            </ContextMenu.Styles>
                        </ContextMenu>
                    </Button.ContextMenu>

                    <common:Icon Content="{DynamicResource AddIcon}" />
                </Button>
                <Button Command="{Binding RemoveSystemCommand}"
                        CommandParameter="{Binding SceneService.ImpliedSelected}"
                        Classes="Icon"
                        ToolTip.Tip="Remove the selected system from the scene">
                    <common:Icon Content="{DynamicResource RemoveIcon}" />
                </Button>
            </StackPanel>

            <TreeView Grid.Row="1"
                      Name="_treeView"
                      Items="{Binding SceneService.CurrentScene, Mode=OneWay, Converter={StaticResource ObjectToEnumerableConverter}}"
                      SelectedItem="{Binding SceneService.Selected, Mode=TwoWay}">
                <TreeView.Styles>
                    <Style Selector="TreeViewItem">
                        <Setter Property="IsExpanded" Value="True" />
                    </Style>
                </TreeView.Styles>

                <TreeView.DataTemplates>
                    <TreeDataTemplate DataType="framework:IScene"
                                      ItemsSource="{Binding NamedChildren}">
                        <common:EditableSelectableItem IsEditable="False"
                                                       HorizontalAlignment="Stretch"
                                                       Icon="{DynamicResource SceneIcon}"
                                                       IconForeground="{StaticResource YellowBrush}"
                                                       Text="{Binding Name}" />
                    </TreeDataTemplate>

                    <TreeDataTemplate DataType="framework:SystemCollection"
                                      ItemsSource="{Binding}">
                        <common:EditableSelectableItem IsEditable="False"
                                                       HorizontalAlignment="Stretch"
                                                       Icon="{DynamicResource SystemIcon}"
                                                       IconForeground="{StaticResource PurpleBrush}"
                                                       Text="{Binding Name}" />
                    </TreeDataTemplate>

                    <TreeDataTemplate DataType="framework:EntityCollection"
                                      ItemsSource="{Binding}">
                        <common:EditableSelectableItem IsEditable="False"
                                                       HorizontalAlignment="Stretch"
                                                       Icon="{DynamicResource EntityIcon}"
                                                       IconForeground="{StaticResource PurpleBrush}"
                                                       Text="{Binding Name}" />
                    </TreeDataTemplate>

                    <TreeDataTemplate DataType="framework:IUpdateableSystem">
                        <common:EditableSelectableItem IsEditable="True"
                                                       TextCommittedCommand="{Binding $parent[local:SceneTreeView].ViewModel.RenameSystemCommand}"
                                                       Text="{Binding Path=Name, Mode=TwoWay}">
                            <common:EditableSelectableItem.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="Rename"
                                              Command="{Binding $parent[common:EditableSelectableItem].EditCommand}"
                                              ToolTip.Tip="Rename this system" />

                                    <Separator />

                                    <MenuItem Header="Remove"
                                              Command="{Binding $parent[local:SceneTreeView].ViewModel.RemoveSystemCommand}"
                                              CommandParameter="{Binding}"
                                              ToolTip.Tip="Remove this system from the scene" />
                                </ContextMenu>
                            </common:EditableSelectableItem.ContextMenu>
                        </common:EditableSelectableItem>
                    </TreeDataTemplate>

                    <TreeDataTemplate DataType="framework:IEntity"
                                      ItemsSource="{Binding Children}">
                        <common:EditableSelectableItem IsEditable="True"
                                                       TextCommittedCommand="{Binding $parent[local:SceneTreeView].ViewModel.RenameEntityCommand}"
                                                       Text="{Binding Path=Name, Mode=TwoWay}"
                                                       PointerPressed="Entity_OnPointerPressed"
                                                       PointerReleased="Entity_OnPointerReleased"
                                                       PointerMoved="Entity_OnPointerMoved"
                                                       DragDrop.AllowDrop="True">
                            <common:EditableSelectableItem.ContextMenu>
                                <ContextMenu>

                                    <MenuItem Header="Rename"
                                              Command="{Binding $parent[common:EditableSelectableItem].EditCommand}"
                                              ToolTip.Tip="Rename this entity" />

                                    <MenuItem Header="Focus"
                                              Command="{Binding $parent[local:SceneTreeView].ViewModel.EditorService.RequestFocusCommand}"
                                              ToolTip.Tip="Focus on this entity in the scene editor" />

                                    <Separator />

                                    <MenuItem Header="Add"
                                              Items="{Binding $parent[local:SceneTreeView].AddEntityMenuItems}">
                                        <MenuItem.Styles>
                                            <Style Selector="MenuItem">
                                                <Setter Property="Command"
                                                        Value="{Binding $parent[local:SceneTreeView].ViewModel.AddEntityCommand}" />
                                            </Style>
                                        </MenuItem.Styles>
                                    </MenuItem>
                                    <MenuItem Header="Remove"
                                              Command="{Binding $parent[local:SceneTreeView].ViewModel.RemoveEntityCommand}"
                                              CommandParameter="{Binding}"
                                              ToolTip.Tip="Remove this entity and all of its children from the scene" />
                                </ContextMenu>
                            </common:EditableSelectableItem.ContextMenu>
                        </common:EditableSelectableItem>
                    </TreeDataTemplate>
                </TreeView.DataTemplates>
            </TreeView>
        </Grid>
    </Border>
</UserControl>